<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 60px 2em 2em; /* –î–æ–±–∞–≤–ª–µ–Ω –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –ø–∞–Ω–µ–ª–∏ */
      padding: 0;
    }

    nav {
      background-color: #007bff;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    nav button {
      padding: 8px 15px;
      background-color: #ffffff;
      color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    nav button:hover {
      background-color: #e0e0e0;
    }

    h1, h2 {
      border-bottom: 1px solid #ccc;
    }

    .section {
      margin-bottom: 3em;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1em;
    }

    .card {
      border: 1px solid #ccc;
      padding: 1em;
      border-radius: 8px;
      background: #f9f9f9;
    }

    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="window.location.href='dashboard.html'">–î–∞—à–±–æ—Ä–¥</button>
    <button onclick="window.location.href='userSettings.html'">–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </nav>

  <h1>üìÅ –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É: <span id="project-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span></h1>

  <div class="section">
    <h2>üìå –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
    <div class="stats-grid">
      <div class="card">–í—Å–µ–≥–æ –∑–∞–¥–∞—á: <strong id="task-count">0</strong></div>
      <div class="card">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <strong id="member-count">0</strong></div>
      <div class="card">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: <strong id="comment-count">0</strong></div>
    </div>
  </div>

  <div class="section">
    <h2>üìà –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á</h2>
    <canvas id="statusChart"></canvas>
  </div>

  <div class="section">
    <h2>üö¶ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á</h2>
    <canvas id="priorityChart"></canvas>
  </div>

  <div class="section">
    <h2>‚è± –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
    <div class="stats-grid">
      <div class="card">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <strong id="avg-time">0—á</strong></div>
      <div class="card">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: <strong id="max-time">0—á</strong></div>
      <div class="card">–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <strong id="total-time">0—á</strong></div>
    </div>
    <canvas id="avgTimeChart"></canvas>
  </div>

  <div class="section">
    <h2>üë• –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
    <canvas id="userTasksChart"></canvas>
    <canvas id="userTimeChart"></canvas>
  </div>

  <div class="section">
    <h2>üìÖ –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–¥–∞—á –≤–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
    <canvas id="tasksOverTimeChart"></canvas>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId') || 'default-project-uuid';
    const API_BASE_URL = 'http://82.202.129.169:8080/api/v1/project';
    const token = sessionStorage.getItem("accessToken");

    const headers = {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    };

    function logout() {
      sessionStorage.removeItem("accessToken");
      window.location.href = "login.html";
    }

    function formatDuration(hours) {
      if (!hours) return '0—á';
      const days = Math.floor(hours / 24);
      const remainingHours = Math.round(hours % 24);
      return days > 0 ? `${days}–¥ ${remainingHours}—á` : `${remainingHours}—á`;
    }

    async function loadGeneralStats() {
      try {
        const response = await fetch(`${API_BASE_URL}/${projectId}/stats`, { headers });
        const data = await response.json();
        document.getElementById('project-name').textContent = data.projectName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç';
        document.getElementById('task-count').textContent = data.taskCount || 0;
        document.getElementById('member-count').textContent = data.memberCount || 0;
        document.getElementById('comment-count').textContent = data.commentCount || 0;
        document.getElementById('avg-time').textContent = formatDuration(data.avgCompletionTime);
        document.getElementById('max-time').textContent = formatDuration(data.maxCompletionTime);
        document.getElementById('total-time').textContent = formatDuration(data.totalTimeSpent);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
      }
    }

    async function loadStatusChart() {
      try {
        const response = await fetch(`${API_BASE_URL}/${projectId}/task-status`, { headers });
        const data = await response.json();
        new Chart(document.getElementById('statusChart'), {
          type: 'doughnut',
          data: {
            labels: data.labels || ['TODO', 'IN_PROGRESS', 'TEST', 'DONE'],
            datasets: [{
              label: '–ó–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É',
              data: data.data || [0, 0, 0, 0],
              backgroundColor: ['#f39c12', '#3498db', '#9b59b6', '#2ecc71']
            }]
          }
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
      }
    }

    async function loadPriorityChart() {
      try {
        const response = await fetch(`${API_BASE_URL}/${projectId}/task-priority`, { headers });
        const data = await response.json();
        new Chart(document.getElementById('priorityChart'), {
          type: 'bar',
          data: {
            labels: data.labels || ['LOW', 'MEDIUM', 'HIGH'],
            datasets: [{
              label: '–ó–∞–¥–∞—á–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É',
              data: data.data || [0, 0, 0],
              backgroundColor: ['#95a5a6', '#f1c40f', '#e74c3c']
            }]
          }
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤:', error);
      }
    }

    async function loadAvgTimeChart() {
      try {
        const response = await fetch(`${API_BASE_URL}/${projectId}/avg-time`, { headers });
        const data = await response.json();
        new Chart(document.getElementById('avgTimeChart'), {
          type: 'line',
          data: {
            labels: data.labels || ['LOW', 'MEDIUM', 'HIGH'],
            datasets: [{
              label: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–Ω–∏)',
              data: data.data || [0, 0, 0],
              borderColor: '#2c3e50',
              fill: false,
              tension: 0.3
            }]
          }
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:', error);
      }
    }

    async function loadUserTasksChart() {
      try {
        const response = await fetch(`${API_BASE_URL}/${projectId}/user-tasks`, { headers });
        const data = await response.json();
        new Chart(document.getElementById('userTasksChart'), {
          type: 'bar',
          data: {
            labels: data.labels || [],
            datasets: [{
              label: '–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏',
              data: data.data || [],
              backgroundColor: '#2980b9'
            }]
          }
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
      }
    }

    async function loadUserTimeChart() {
      try {
        const response = await fetch(`${API_BASE_URL}/${projectId}/user-time`, { headers });
        const data = await response.json();
        new Chart(document.getElementById('userTimeChart'), {
          type: 'bar',
          data: {
            labels: data.labels || [],
            datasets: [{
              label: '–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ —á–∞—Å—ã',
              data: data.data || [],
              backgroundColor: '#8e44ad'
            }]
          }
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
      }
    }

    async function loadTasksOverTimeChart() {
      try {
        const response = await fetch(`${API_BASE_URL}/${projectId}/tasks-over-time`, { headers });
        const data = await response.json();
        new Chart(document.getElementById('tasksOverTimeChart'), {
          type: 'line',
          data: {
            labels: data.labels || [],
            datasets: [{
              label: '–í—Å–µ–≥–æ –∑–∞–¥–∞—á',
              data: data.data || [],
              borderColor: '#27ae60',
              fill: false,
              tension: 0.3
            }]
          }
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏ –∑–∞–¥–∞—á:', error);
      }
    }

    Promise.all([
      loadGeneralStats(),
      loadStatusChart(),
      loadPriorityChart(),
      loadAvgTimeChart(),
      loadUserTasksChart(),
      loadUserTimeChart(),
      loadTasksOverTimeChart()
    ]).catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error));
  </script>
</body>
</html>