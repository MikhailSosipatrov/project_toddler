<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ç—á–µ—Ç –ø–æ –∑–∞–¥–∞—á–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 60px 2em 2em;
      padding: 0;
    }

    nav {
      background-color: #007bff;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    nav button {
      padding: 8px 15px;
      background-color: #ffffff;
      color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    nav button:hover {
      background-color: #e0e0e0;
    }

    h1, h2 {
      border-bottom: 1px solid #ccc;
      margin-top: 2em;
    }

    .info p, .logs li, .timeline li {
      margin: 0.5em 0;
    }

    .info {
      margin-bottom: 2em;
    }

    .timeline, .logs {
      margin-left: 1em;
      margin-bottom: 2em;
    }

    .chart-container {
      margin: 2em 0;
    }

    canvas {
      max-width: 100%;
      height: auto;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="window.location.href='dashboard.html'">–î–∞—à–±–æ—Ä–¥</button>
    <button onclick="window.location.href='userSettings.html'">–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </nav>

  <h1>üìå –û—Ç—á–µ—Ç –ø–æ –∑–∞–¥–∞—á–µ: <span id="task-title">–ó–∞–≥—Ä—É–∑–∫–∞...</span></h1>

  <div class="info">
    <p>–°—Ç–∞—Ç—É—Å: <strong id="task-status">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></p>
    <p>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: <strong id="task-priority">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></p>
    <p>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <strong id="task-assignee">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></p>
    <p>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: <strong id="task-created">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></p>
    <p>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <strong id="task-due">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></p>
  </div>

  <h2>üìä –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤</h2>
  <ul class="timeline" id="status-timeline">
    <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
  </ul>

  <div class="chart-container">
    <h2>üìà –ì—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤</h2>
    <canvas id="statusTimelineChart"></canvas>
  </div>

  <h2>‚è± –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–æ–≥–∏</h2>
  <ul class="logs" id="time-logs">
    <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
  </ul>
  <p><strong id="total-hours">–ò—Ç–æ–≥–æ: –ó–∞–≥—Ä—É–∑–∫–∞...</strong></p>

  <div class="chart-container">
    <h2>‚è≤Ô∏è –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç</h2>
    <canvas id="timeSpentChart"></canvas>
  </div>

  <h2>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
  <ul class="logs" id="comments">
    <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
  </ul>

  <div class="chart-container">
    <h2>üìÖ –í–∫–ª–∞–¥ –ø–æ –¥–∞—Ç–∞–º</h2>
    <canvas id="dailyContributionChart"></canvas>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('id');
    const API_BASE_URL = 'http://82.202.129.169:8080/api/v1/tasks/report';
    const token = sessionStorage.getItem("accessToken");

    const headers = {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    };

    function logout() {
      sessionStorage.removeItem("accessToken");
      window.location.href = "login.html";
    }

    const formatDate = (dateStr) => {
      if (!dateStr) return '–ù/–î';
      return new Date(dateStr).toLocaleDateString('ru-RU');
    };

    const formatHours = (hours) => {
      if (!hours || hours <= 0) return '0 –º–∏–Ω—É—Ç';
      const totalMinutes = Math.round(hours * 60); // Convert hours to minutes and round
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      if (h > 0 && m > 0) return `${h} —á–∞—Å–æ–≤ ${m} –º–∏–Ω—É—Ç`;
      if (h > 0) return `${h} —á–∞—Å–æ–≤`;
      return `${m} –º–∏–Ω—É—Ç`;
    };

    const calculateHours = (start, end) => {
      if (!end) return 0;
      const diff = new Date(end) - new Date(start);
      return (diff / 1000 / 60 / 60).toFixed(2);
    };

    async function fetchTaskDetails() {
      try {
        const response = await fetch(`${API_BASE_URL}/${taskId}`, { headers });
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏');
        const task = await response.json();
        document.getElementById('task-title').textContent = task.title;
        document.getElementById('task-status').textContent = task.status;
        document.getElementById('task-priority').textContent = task.priority;
        document.getElementById('task-assignee').textContent = task.assigneeName || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
        document.getElementById('task-created').textContent = formatDate(task.createdAt);
        document.getElementById('task-due').textContent = formatDate(task.dueDate);
      } catch (error) {
        document.getElementById('task-title').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('task-title').classList.add('error');
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏:', error);
      }
    }

    async function fetchStatusHistory() {
      try {
        const response = await fetch(`${API_BASE_URL}/${taskId}/status-history`, { headers });
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤');
        const history = await response.json();
        const timeline = document.getElementById('status-timeline');
        timeline.innerHTML = history.length ? '' : '<li>–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤</li>';
        history.forEach(h => {
          const li = document.createElement('li');
          li.textContent = `${h.status} (—Å ${formatDate(h.statusEnteredAt)}${h.statusLeftAt ? ` –¥–æ ${formatDate(h.statusLeftAt)}` : ''})`;
          timeline.appendChild(li);
        });

        new Chart(document.getElementById('statusTimelineChart'), {
          type: 'bar',
          data: {
            labels: history.map(h => h.status),
            datasets: [{
              label: '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–≤ —á–∞—Å–∞—Ö)',
              data: history.map(h => calculateHours(h.statusEnteredAt, h.statusLeftAt || new Date())),
              backgroundColor: ['#f39c12', '#3498db', '#2ecc71', '#e74c3c']
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { title: { display: true, text: '–ß–∞—Å—ã' } } }
          }
        });
      } catch (error) {
        document.getElementById('status-timeline').innerHTML = '<li class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤</li>';
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
      }
    }

    async function fetchTimeLogs() {
      try {
        const response = await fetch(`${API_BASE_URL}/${taskId}/time-logs`, { headers });
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–æ–≥–∏');
        const logs = await response.json();
        const logList = document.getElementById('time-logs');
        logList.innerHTML = logs.length ? '' : '<li>–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤</li>';
        logs.forEach(log => {
          const li = document.createElement('li');
          li.textContent = `${log.userName}: ${formatHours(log.hours)} (${formatDate(log.startTime)})`;
          logList.appendChild(li);
        });
        const totalHours = logs.reduce((sum, log) => sum + parseFloat(log.hours), 0);
        document.getElementById('total-hours').textContent = `–ò—Ç–æ–≥–æ: ${formatHours(totalHours)}`;

        new Chart(document.getElementById('timeSpentChart'), {
          type: 'pie',
          data: {
            labels: logs.map(log => log.userName),
            datasets: [{
              label: '–ß–∞—Å—ã',
              data: logs.map(log => log.hours),
              backgroundColor: ['#8e44ad', '#3498db', '#2ecc71']
            }]
          }
        });

        const dailyHours = {};
        logs.forEach(log => {
          const date = formatDate(log.startTime);
          dailyHours[date] = (dailyHours[date] || 0) + parseFloat(log.hours);
        });
        new Chart(document.getElementById('dailyContributionChart'), {
          type: 'line',
          data: {
            labels: Object.keys(dailyHours),
            datasets: [{
              label: '–ß–∞—Å—ã –≤ –¥–µ–Ω—å',
              data: Object.values(dailyHours),
              borderColor: '#2ecc71',
              backgroundColor: '#2ecc7144',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true, title: { display: true, text: '–ß–∞—Å—ã' } },
              x: { title: { display: true, text: '–î–∞—Ç–∞' } }
            }
          }
        });
      } catch (error) {
        document.getElementById('time-logs').innerHTML = '<li class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤</li>';
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤:', error);
      }
    }

    async function fetchComments() {
      try {
        const response = await fetch(`${API_BASE_URL}/${taskId}/comments`, { headers });
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
        const comments = await response.json();
        const commentList = document.getElementById('comments');
        commentList.innerHTML = comments.length ? '' : '<li>–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</li>';
        comments.forEach(c => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${c.userName}:</strong> ${c.content} (${formatDate(c.createdAt)})`;
          commentList.appendChild(li);
        });
      } catch (error) {
        document.getElementById('comments').innerHTML = '<li class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</li>';
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
      }
    }

    async function loadReport() {
      await Promise.all([
        fetchTaskDetails(),
        fetchStatusHistory(),
        fetchTimeLogs(),
        fetchComments()
      ]);
    }

    if (taskId) {
      loadReport();
    } else {
      document.getElementById('task-title').textContent = '–û—à–∏–±–∫–∞: ID –∑–∞–¥–∞—á–∏ –Ω–µ —É–∫–∞–∑–∞–Ω';
      document.getElementById('task-title').classList.add('error');
    }
  </script>
</body>
</html>